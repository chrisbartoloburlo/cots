---
layout: default
title: Generator
---
<script type="text/javascript" src="jszip.js"></script>
<style type="text/css" media="screen">
  #steditor { 
    position: relative;
    margin: auto;
    width: 700px;
    height: 200px;
  }
  #utileditor { 
    position: relative;
    margin: auto;
    width: 700px;
    height: 300px;
  }
  #openapieditor{
    position: relative;
    margin: auto;
    width: 700px;
    height: 800px;
  }
  h1,h2,p {
    text-align: center;
  }
  .inputField {
    /* border: 5px solid; */
    margin: auto;
    width: 70%;
    padding: 10px;
  }
  .column {
    float: left;
    width: 50%;
  }
  .row:after {
    content: "";
    display: table;
    clear: both;
  }
</style>

<div class="row">
  
  <div class="column"></div>
</div> 

<div>
  <div>
    <h1>Generator</h1>
  </div>
  <div class="row">
    <div class="column">
      <h2>.st file</h2>
      <div id="steditor">S_store=!UserApi.addUser(username: String(const "Chris")).?C201().
        !UserApi.listUsers().?C200(users: "Seq[String]")</div>
      <br></br>
      <div>
        <h2>Util file</h2>
      </div>
      <div id="utileditor">package store
import store.model._
import scala.util.Random
object util {
  //write generator functions and assertions here
  def genInt(rand: Random): Int = {
    rand.nextInt()
  }
  def const(string: String, rand: Random): Option[String] = {
    Some(string)
  }
  def assertEmpty(name: String): Boolean = {
    name.isEmpty()
  }
  def getUserFields(rand: Random): UserFields = {
      UserFields.apply(Some("test"))
  }
}</div>
      <br></br>
      <div class="inputField">
        <label for="name">Package Name:</label>
        <input type="text" id="name" name="name" required size="15">
        <button onclick="downloadZipFile()">Download files</button>
        <button onclick="generateDriver()">Generate driver</button>
        <p id = "resultGenerateDriver"></p>
      </div>
      <div style="text-align: center;">
        <div style="display: inline-block; text-align: left; margin-left:20px;  width: 700px;">
          <h3 style="text-align: left;">Follow these steps to generate and package a test driver:</h3><br>
          <b>1.</b> Import the schema file in  <code>.yaml</code> format (in the editor on the right).<br>
          <b>2.</b> Write the specification in the <code>.st</code> editor by:<br>
          &nbsp; &nbsp; &nbsp;a. Finding the respective <code>operationId</code> of the operation from the OpenAPI spec.<br>
          &nbsp; &nbsp; &nbsp;b. Writing the <code>operationId</code> prefixed with the respective <code>tag</code> in the <code>.st</code> editor.<br>
          &nbsp; &nbsp; &nbsp;c. Writing any functions required (such as generators or assertions) in the <code>Util</code> file. <br>
          <b>3.</b> Once the specification is ready, in the text box next to "Package Name" write the respective package name (<code>store</code> in the case of the example) and click on "Generate Driver".<br>
          <b>4.</b> In the downloaded file, open a terminal and run "sbt assembly" which will package the driver files, avoiding compilation every time we want to execute the driver. <br>
          <b>5.</b> To run the driver itself, execute: <code>java -cp target/scala-2.13/$(package)-assembly-0.0.3.jar $(package).Wrapper $(iterations)</code> Replace <code>$(package)</code> with the respective package name and <code>$(iterations)</code> with the number of tests to be executed. <br>
          <b>6.</b> The test driver should execute automatically on the SUT.
        </div>
      </div>
    </div>
    <div class="column">
      <h2>OpenAPI Spec</h2>
      <div class="inputField">
        <tr>
          <td>Select a File to Load:</td>
          <td><input type="file" id="fileToLoad"></td>
          <td><button onclick="loadFileAsText()" data-target="#openapieditor">Load Selected File</button><td>
        </tr>
      </div>
      <div id="openapieditor"></div>
    </div>
  </div>
</div>

<script src="src/ace.js" type="text/javascript" charset="utf-8"></script>

<script>
  var steditor = ace.edit("steditor");
  steditor.setTheme("ace/theme/dawn");
  steditor.session.setMode("ace/mode/st");

  var scalaeditor1 = ace.edit("utileditor");
  scalaeditor1.setTheme("ace/theme/dawn");
  scalaeditor1.session.setMode("ace/mode/scala");

  var openapieditor = ace.edit("openapieditor");
  openapieditor.setTheme("ace/theme/dawn");

  function downloadZipFile() {
    var zip = new JSZip();
    var stCode = steditor.getSession().getValue();
    const link = document.createElement("a");
    const content = stCode;
    const stfile = new Blob([content]);
    zip.file(document.getElementById('name').value+".st", stfile);

    const utilFile = new Blob([scalaeditor1.getSession().getValue()])
    zip.file("util.scala", utilFile);

    const openapiFile = new Blob([openapieditor.getSession().getValue()])
    zip.file("schema.yaml", openapiFile);

    const preamble = new Blob(["package  "+document.getElementById('name').value+"\nimport "+document.getElementById('name').value+".api._\nimport "+document.getElementById('name').value+".model._"])
    zip.file("preamble.txt", preamble);

    zip.generateAsync({type: "base64"}).then(function(content) {
      var link = document.createElement('a');
      link.href = "data:application/zip;base64," + content;
      link.download = document.getElementById('name').value+".zip";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
  }

  function generateDriver() {
    var resultGenerateDriver = document.getElementById("resultGenerateDriver");
    resultGenerateDriver.innerText = "Loading...";
    var zip = new JSZip();
    var stCode = steditor.getSession().getValue();
    const link = document.createElement("a");
    const content = stCode;
    const stfile = new Blob([content]);
    zip.file(document.getElementById('name').value+".st", stfile);

    const utilFile = new Blob([scalaeditor1.getSession().getValue()])
    zip.file("util.scala", utilFile);

    const openapiFile = new Blob([openapieditor.getSession().getValue()])
    zip.file("schema.yaml", openapiFile);

    const preamble = new Blob(["package  "+document.getElementById('name').value+"\nimport "+document.getElementById('name').value+".api._\nimport "+document.getElementById('name').value+".model._"])
    zip.file("preamble.txt", preamble);

    zip.generateAsync({type: "blob"}).then(function(content) {
    var formdata = new FormData();
    formdata.append("name", document.getElementById('name').value);
    formdata.append("file", content, document.getElementById('name').value+".zip");

    var myHeaders = new Headers();
    myHeaders.append("Access-Control-Allow-Origin", "*");

    var requestOptions = {
      method: 'POST',
      headers: myHeaders,
      body: formdata,
      redirect: 'follow'
    };

    fetch("https://cots-service.com/driver", requestOptions)
    .then((transfer) => {
      if(transfer.status === 201) {
        resultGenerateDriver.innerText = "Driver generated successfully"
      } else {
        resultGenerateDriver.innerText = "Problem when generating driver"
      }
      return transfer.blob();                 // RETURN DATA TRANSFERED AS BLOB
    }).then((bytes) => {
      let elm = document.createElement('a');  // CREATE A LINK ELEMENT IN DOM
      elm.href = URL.createObjectURL(bytes);  // SET LINK ELEMENTS CONTENTS
      elm.setAttribute('download', document.getElementById('name').value+"_driver.zip"); // SET ELEMENT CREATED 'ATTRIBUTE' TO DOWNLOAD, FILENAME PARAM AUTOMATICALLY
      elm.click()                             // TRIGGER ELEMENT TO DOWNLOAD
    }).catch((error) => {
      console.log(error);                     // OUTPUT ERRORS, SUCH AS CORS WHEN TESTING NON LOCALLY
    })
    });
  }
   
   function loadFileAsText(){
     openapieditor.session.setValue()
     var fileToLoad = document.getElementById("fileToLoad").files[0];
     var fileExt = fileToLoad.name.split('.').pop();
     openapieditor.session.setMode("ace/mode/"+fileExt);

     var fileReader = new FileReader();
     fileReader.onload = function(fileLoadedEvent){
         var textFromFileLoaded = fileLoadedEvent.target.result;
         // document.getElementById("inputTextToSave").value = textFromFileLoaded;
         openapieditor.insert(textFromFileLoaded);
     };

     fileReader.readAsText(fileToLoad, "UTF-8");
   }
</script>